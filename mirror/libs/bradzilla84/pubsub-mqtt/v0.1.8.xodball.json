{
  "description": "Arduino Client for MQTT (Updated)\nThis library provides a client for doing simple publish/subscribe messaging with a server that supports MQTT.",
  "license": "GPL",
  "name": "pubsub-mqtt",
  "patches": {
    "@/example": {
      "links": {
        "B1CsLMyEN": {
          "id": "B1CsLMyEN",
          "input": {
            "nodeId": "BypjIMyVN",
            "pinKey": "H1hC6Xnk4"
          },
          "output": {
            "nodeId": "rJGXK4o7E",
            "pinKey": "rJ8FY7nyE"
          }
        },
        "B1SqhGkNN": {
          "id": "B1SqhGkNN",
          "input": {
            "nodeId": "rJ0Fhzy4N",
            "pinKey": "ByQ4aXnyE"
          },
          "output": {
            "nodeId": "BypjIMyVN",
            "pinKey": "By6-JMT14"
          }
        },
        "HyCpMBiXN": {
          "id": "HyCpMBiXN",
          "input": {
            "nodeId": "rJGXK4o7E",
            "pinKey": "ByQ4aXnyE"
          },
          "output": {
            "nodeId": "BkjaMrimN",
            "pinKey": "HJU8CE2lW"
          }
        },
        "HyhUJNsmE": {
          "id": "HyhUJNsmE",
          "input": {
            "nodeId": "HycLy4sX4",
            "pinKey": "Bygji-oQN"
          },
          "output": {
            "nodeId": "rkDKs-jQV",
            "pinKey": "H1Gd15UFQ"
          }
        },
        "HyyxW3MNV": {
          "id": "HyyxW3MNV",
          "input": {
            "nodeId": "rJ0Fhzy4N",
            "pinKey": "BJSrpWTyE"
          },
          "output": {
            "nodeId": "S1KJy2fEN",
            "pinKey": "r1H_oipZb"
          }
        },
        "SkTyx3GVN": {
          "id": "SkTyx3GVN",
          "input": {
            "nodeId": "H1FJxhG4N",
            "pinKey": "B1GfLR_SPk-"
          },
          "output": {
            "nodeId": "rycARofNN",
            "pinKey": "HkBWIjMEV"
          }
        },
        "SkW9hf1NV": {
          "id": "SkW9hf1NV",
          "input": {
            "nodeId": "rJ0Fhzy4N",
            "pinKey": "HyEYKX3kV"
          },
          "output": {
            "nodeId": "BypjIMyVN",
            "pinKey": "S1x3CTX3k4"
          }
        },
        "rkp0CszNE": {
          "id": "rkp0CszNE",
          "input": {
            "nodeId": "rycARofNN",
            "pinKey": "S11Z8oGN4"
          },
          "output": {
            "nodeId": "BypjIMyVN",
            "pinKey": "Bk7yK-BeE"
          }
        },
        "rkyexnfNN": {
          "id": "rkyexnfNN",
          "input": {
            "nodeId": "S1KJy2fEN",
            "pinKey": "BJlHojaWZ"
          },
          "output": {
            "nodeId": "H1FJxhG4N",
            "pinKey": "BkQzLCurwJZ"
          }
        },
        "ry3EMroQE": {
          "id": "ry3EMroQE",
          "input": {
            "nodeId": "rJGXK4o7E",
            "pinKey": "HyEYKX3kV"
          },
          "output": {
            "nodeId": "HycLy4sX4",
            "pinKey": "rJg_d3hoy4"
          }
        }
      },
      "nodes": {
        "BkjaMrimN": {
          "boundLiterals": {
            "B13SCNhl-": "10"
          },
          "id": "BkjaMrimN",
          "position": {
            "x": 272,
            "y": 204
          },
          "type": "xod/core/clock"
        },
        "BypjIMyVN": {
          "boundLiterals": {
            "r1GhRamnJ4": "\"/Ard\""
          },
          "id": "BypjIMyVN",
          "position": {
            "x": 34,
            "y": 408
          },
          "type": "@/mqtt-subscribe"
        },
        "H1FJxhG4N": {
          "boundLiterals": {
            "SJ4zUC_BD1-": "10"
          },
          "id": "H1FJxhG4N",
          "position": {
            "x": 68,
            "y": 612
          },
          "type": "xod/core/multiply"
        },
        "HycLy4sX4": {
          "id": "HycLy4sX4",
          "position": {
            "x": 34,
            "y": 204
          },
          "type": "@/mqtt-device"
        },
        "S1KJy2fEN": {
          "boundLiterals": {
            "HJTIija-W": "0"
          },
          "id": "S1KJy2fEN",
          "position": {
            "x": 68,
            "y": 714
          },
          "type": "xod/core/format-number"
        },
        "rJ0Fhzy4N": {
          "boundLiterals": {
            "BJSrpWTyE": "\"Alive\"",
            "SyWgnXnJ4": "\"/Output\""
          },
          "id": "rJ0Fhzy4N",
          "position": {
            "x": 34,
            "y": 816
          },
          "type": "@/mqtt-publish"
        },
        "rJGXK4o7E": {
          "boundLiterals": {
            "BJSrpWTyE": "\"Alive\"",
            "SyWgnXnJ4": "\"/heartbeat\""
          },
          "id": "rJGXK4o7E",
          "position": {
            "x": 34,
            "y": 306
          },
          "type": "@/mqtt-publish"
        },
        "rkDKs-jQV": {
          "boundLiterals": {
            "H1z0HpF8Km": "\"\"",
            "HJZCrpKLYX": "\"\""
          },
          "id": "rkDKs-jQV",
          "position": {
            "x": 34,
            "y": 102
          },
          "type": "xod-dev/esp8266-mcu/connect"
        },
        "rycARofNN": {
          "id": "rycARofNN",
          "position": {
            "x": 68,
            "y": 510
          },
          "type": "bradzilla84/bradzilla84-utilities/string-to-int"
        }
      },
      "path": "@/example"
    },
    "@/mqtt-connect": {
      "attachments": [
        {
          "content": "\n// clang-format off\n{{#global}}\n#include <ESP8266WiFi.h>\nchar* topicG;\nchar* payloadG;\nunsigned int lengthG = 0;\n{{/global}}\n// clang-format on\n\nstruct State {\n};\n\n// clang-format off\n{{ GENERATED_CODE }}\n// clang-format on\n\nvoid evaluate(Context ctx) {\n    auto MQTT = getValue<input_MQTT>(ctx);\n    auto state = getState(ctx);\n\n    if (isInputDirty<input_CONN>(ctx)) {\n\n            emitValue<output_DONE>(ctx, true);\n            emitValue<output_OUT>(ctx, MQTT);\n\n    }\n\n\n}\n",
          "encoding": "utf-8",
          "filename": "patch.cpp"
        }
      ],
      "nodes": {
        "B1Gew23i14": {
          "description": "Pulses if the connection failed\n",
          "id": "B1Gew23i14",
          "label": "ERR",
          "position": {
            "x": 68,
            "y": 204
          },
          "type": "xod/patch-nodes/output-pulse"
        },
        "H18evn2oJV": {
          "boundLiterals": {
            "__out__": "On Boot"
          },
          "description": "Establish the connection",
          "id": "H18evn2oJV",
          "label": "CONN",
          "position": {
            "x": 340,
            "y": 0
          },
          "type": "xod/patch-nodes/input-pulse"
        },
        "H1Ac2njk4": {
          "id": "H1Ac2njk4",
          "position": {
            "x": 0,
            "y": 204
          },
          "type": "@/output-mqtt-device"
        },
        "HyExD33s1V": {
          "description": "Pulses on a successful connection\n",
          "id": "HyExD33s1V",
          "label": "DONE",
          "position": {
            "x": 34,
            "y": 204
          },
          "type": "xod/patch-nodes/output-pulse"
        },
        "rJDn22iJN": {
          "id": "rJDn22iJN",
          "label": "MQTT",
          "position": {
            "x": 0,
            "y": 0
          },
          "type": "@/input-mqtt-device"
        },
        "rJyGcx3yV": {
          "boundLiterals": {
            "__out__": "1883"
          },
          "id": "rJyGcx3yV",
          "label": "Port",
          "position": {
            "x": 102,
            "y": 0
          },
          "type": "xod/patch-nodes/input-number"
        },
        "ryev2niy4": {
          "id": "ryev2niy4",
          "position": {
            "x": 0,
            "y": 102
          },
          "type": "xod/patch-nodes/not-implemented-in-xod"
        }
      },
      "path": "@/mqtt-connect"
    },
    "@/mqtt-device": {
      "attachments": [
        {
          "filename": "patch.cpp",
          "encoding": "utf-8",
          "content": "#pragma XOD require \"https://github.com/256dpi/arduino-mqtt\"\n\n// Include C++ library:\n{{#global}}\n#include <MQTT.h>\nString Buff [10][2]; //Setup buffer\nint Buffloc = 0; //current buffer location\n\nvoid messageReceived(String &topic, String &payload) {\n    if(Buffloc > 10){Buffloc = 0;}\n    Buff[Buffloc][0] = topic; //Populate buffer\n    Buff[Buffloc][1] = payload;\n    Buffloc = Buffloc +1;\n}\n{{/global}}\n\n\nstruct State {\n    uint8_t mem[sizeof(MQTTClient)];\n    WiFiClient client;\n};\n\n// Define our custom type as a pointer on the class instance.\nusing Type = MQTTClient*;\n\n{{ GENERATED_CODE }}\n\nvoid evaluate(Context ctx) {\n    // It should be evaluated only once on the first (setup) transaction\n    if (isSettingUp()){\n\n    auto state = getState(ctx);\n\n    // Create a new object in the memory area reserved previously.\n    Type MQTT = new (state->mem) MQTTClient();\n\n        auto server = getValue<input_Server>(ctx);\n        auto serverLength = length(server);\n        char _server[serverLength + 1];\n        dump(server, _server);\n        _server[serverLength] = '\\0';\n\n\n\n        auto username = getValue<input_Username>(ctx);\n        auto usernameLength = length(username);\n        char _username[usernameLength + 1];\n        dump(username, _username);\n        _username[usernameLength] = '\\0';\n\n        auto password = getValue<input_Password>(ctx);\n        auto passwordLength = length(password);\n        char _password[passwordLength + 1];\n        dump(password, _password);\n        _password[passwordLength] = '\\0';\n\n        auto id = getValue<input_ID>(ctx);\n        auto idLength = length(id);\n        char _id[idLength + 1];\n        dump(id, _id);\n        _id[idLength] = '\\0';\n\n    MQTT->begin(_server, state->client);\n    MQTT->onMessage(messageReceived);\n    while (!MQTT->connect(_id, _username, _password)) {\n      delay(1000);\n        }\n    }\n    auto state = getState(ctx);\n    auto MQTT = reinterpret_cast<MQTTClient*>(state->mem);\n    MQTT->loop();\n    delay(10);\n    emitValue<output_MQTT>(ctx, MQTT);\n}\n"
        }
      ],
      "description": "MQTT Device setup. Username and Password are optional.",
      "nodes": {
        "BkZBBaEsQN": {
          "boundLiterals": {
            "__out__": "\"try\""
          },
          "description": "Leave Blank for NONE",
          "id": "BkZBBaEsQN",
          "label": "Username",
          "position": {
            "x": 204,
            "y": 0
          },
          "type": "xod/patch-nodes/input-string"
        },
        "Bygji-oQN": {
          "id": "Bygji-oQN",
          "label": "INET",
          "position": {
            "x": 0,
            "y": 0
          },
          "type": "xod-dev/esp8266-mcu/input-esp8266-mcu-inet"
        },
        "ByxHBa4oXE": {
          "boundLiterals": {
            "__out__": "\"Arduino\""
          },
          "description": "The ID of This device to show in MQTT",
          "id": "ByxHBa4oXE",
          "label": "ID",
          "position": {
            "x": 136,
            "y": 0
          },
          "type": "xod/patch-nodes/input-string"
        },
        "HyMrBpViQN": {
          "boundLiterals": {
            "__out__": "\"try\""
          },
          "description": "Leave Blank for NONE",
          "id": "HyMrBpViQN",
          "label": "Password",
          "position": {
            "x": 238,
            "y": 0
          },
          "type": "xod/patch-nodes/input-string"
        },
        "r1rBTEoQN": {
          "boundLiterals": {
            "__out__": "\"192.168.1.1\""
          },
          "description": "MQTT Server",
          "id": "r1rBTEoQN",
          "label": "Server",
          "position": {
            "x": 68,
            "y": 0
          },
          "type": "xod/patch-nodes/input-string"
        },
        "r1uO3hiJE": {
          "id": "r1uO3hiJE",
          "position": {
            "x": 0,
            "y": 102
          },
          "type": "xod/patch-nodes/not-implemented-in-xod"
        },
        "rJg_d3hoy4": {
          "id": "rJg_d3hoy4",
          "label": "MQTT",
          "position": {
            "x": 0,
            "y": 204
          },
          "type": "xod/patch-nodes/output-self"
        }
      },
      "path": "@/mqtt-device"
    },
    "@/mqtt-publish": {
      "attachments": [
        {
          "content": "\nstruct State {\n};\n\n{{ GENERATED_CODE }}\n\nvoid evaluate(Context ctx) {\n    if (!isInputDirty<input_INIT>(ctx)){\n    emitValue<output_OUT>(ctx, getValue<input_MQTT>(ctx));\n        return;}\n\n    auto MQTT = getValue<input_MQTT>(ctx);\n\n    auto payload = getValue<input_Payload>(ctx);\n    auto payloadLength = length(payload);\n    char _payload[payloadLength + 1];\n    dump(payload, _payload);\n    _payload[payloadLength] = '\\0';\n\n    auto topic = getValue<input_Topic>(ctx);\n    auto topicLength = length(topic);\n    char _topic[topicLength + 1];\n    dump(topic, _topic);\n    _topic[topicLength] = '\\0';\n\n    MQTT->publish(_topic, _payload, getValue<input_Retaine>(ctx), getValue<input_QOS>(ctx));\n    emitValue<output_OUT>(ctx, MQTT);\n}\n",
          "encoding": "utf-8",
          "filename": "patch.cpp"
        }
      ],
      "description": "Publish a message to a Topic",
      "nodes": {
        "BJSrpWTyE": {
          "description": "The message to publish",
          "id": "BJSrpWTyE",
          "label": "Payload",
          "position": {
            "x": 136,
            "y": 0
          },
          "type": "xod/patch-nodes/input-string"
        },
        "ByQ4aXnyE": {
          "description": "SEND",
          "id": "ByQ4aXnyE",
          "label": "INIT",
          "position": {
            "x": 340,
            "y": 0
          },
          "type": "xod/patch-nodes/input-pulse"
        },
        "Hy2KFQh1N": {
          "id": "Hy2KFQh1N",
          "position": {
            "x": 0,
            "y": 102
          },
          "type": "xod/patch-nodes/not-implemented-in-xod"
        },
        "HyEYKX3kV": {
          "id": "HyEYKX3kV",
          "label": "MQTT",
          "position": {
            "x": 0,
            "y": 0
          },
          "type": "@/input-mqtt-device"
        },
        "S17WFtG4N": {
          "id": "S17WFtG4N",
          "label": "QOS",
          "position": {
            "x": 272,
            "y": 0
          },
          "type": "xod/patch-nodes/input-number"
        },
        "SJMeKYf44": {
          "id": "SJMeKYf44",
          "label": "Retaine",
          "position": {
            "x": 204,
            "y": 0
          },
          "type": "xod/patch-nodes/input-boolean"
        },
        "SyWgnXnJ4": {
          "description": "The topic to publish to",
          "id": "SyWgnXnJ4",
          "label": "Topic",
          "position": {
            "x": 68,
            "y": 0
          },
          "type": "xod/patch-nodes/input-string"
        },
        "rJ8FY7nyE": {
          "id": "rJ8FY7nyE",
          "label": "OUT",
          "position": {
            "x": 0,
            "y": 204
          },
          "type": "@/output-mqtt-device"
        }
      },
      "path": "@/mqtt-publish"
    },
    "@/mqtt-subscribe": {
      "attachments": [
        {
          "filename": "patch.cpp",
          "encoding": "utf-8",
          "content": "struct State {\n    String Ctopic;\n    char str[16];\n    CStringView view;\n    State() : view(str) { }\n};\n\n{{ GENERATED_CODE }}\n\nvoid evaluate(Context ctx) {\n    if (!isInputDirty<input_Update>(ctx)){\n    emitValue<output_OUT>(ctx, getValue<input_MQTT>(ctx));\n        return;}\n\n\n\n    if (isSettingUp()){\n    auto MQTT = getValue<input_MQTT>(ctx);\n    auto state = getState(ctx);\n    auto topic = getValue<input_Topic>(ctx);\n    auto topicLength = length(topic);\n    char _topic[topicLength + 1];\n    dump(topic, _topic);\n    _topic[topicLength] = '\\0';\n    state->Ctopic = String(_topic);\n    MQTT->subscribe(_topic);\n    return;\n    }\n\n    auto MQTT = getValue<input_MQTT>(ctx);\n    auto state = getState(ctx);\n    MQTT->loop();\n\n    for(int i=0; i<10; i++) //cycle thrue the buffer\n    {\n    if(state->Ctopic == Buff [i][0]){     //topics (global from callback) against Ctopic (Current Topic)\n        //Serial.println(\"incoming: \" + Gtopic + \" - \" + Gpayload);\n        Buff [i][1].toCharArray(state->str, 16);  //Check messages in buffer that matter to this node\n        Buff [i][0] = \"\";\n        Buff [i][1] = \"\";\n        emitValue<output_Message>(ctx, XString(&state->view));\n        emitValue<output_OK>(ctx, 1);\n          }\n    }\n\n    emitValue<output_OUT>(ctx, MQTT);\n}\n"
        }
      ],
      "description": "Subscribe to a MQTT Topic.",
      "nodes": {
        "Bk7yK-BeE": {
          "description": "Incomming message.",
          "id": "Bk7yK-BeE",
          "label": "Message",
          "position": {
            "x": 68,
            "y": 204
          },
          "type": "xod/patch-nodes/output-string"
        },
        "By6-JMT14": {
          "description": "Subscribed OK",
          "id": "By6-JMT14",
          "label": "OK",
          "position": {
            "x": 170,
            "y": 204
          },
          "type": "xod/patch-nodes/output-pulse"
        },
        "H1hC6Xnk4": {
          "id": "H1hC6Xnk4",
          "label": "MQTT",
          "position": {
            "x": -1,
            "y": -1
          },
          "type": "@/input-mqtt-device"
        },
        "S19DoKNe4": {
          "boundLiterals": {
            "__out__": "Continuously"
          },
          "description": "Update incomming messages. (Needs to be quick/Continuous)",
          "id": "S19DoKNe4",
          "label": "Update",
          "position": {
            "x": 204,
            "y": 0
          },
          "type": "xod/patch-nodes/input-pulse"
        },
        "S1x3CTX3k4": {
          "id": "S1x3CTX3k4",
          "label": "OUT",
          "position": {
            "x": -1,
            "y": 203
          },
          "type": "@/output-mqtt-device"
        },
        "r1GhRamnJ4": {
          "boundLiterals": {
            "__out__": "\"/Arduino\""
          },
          "description": "The topic to publish to",
          "id": "r1GhRamnJ4",
          "label": "Topic",
          "position": {
            "x": 67,
            "y": -1
          },
          "type": "xod/patch-nodes/input-string"
        },
        "rkb2RaX31V": {
          "id": "rkb2RaX31V",
          "position": {
            "x": 0,
            "y": 102
          },
          "type": "xod/patch-nodes/not-implemented-in-xod"
        }
      },
      "path": "@/mqtt-subscribe"
    }
  },
  "version": "0.1.8"
}
