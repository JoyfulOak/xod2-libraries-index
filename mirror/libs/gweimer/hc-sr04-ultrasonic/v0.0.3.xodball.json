{
  "patches": {
    "@/example": {
      "nodes": {
        "S1vSYencM": {
          "boundLiterals": {
            "SkDHCxlLG": "15",
            "HyZDrAxeIG": "14"
          },
          "id": "S1vSYencM",
          "position": {
            "x": 2,
            "y": 1,
            "units": "slots"
          },
          "type": "@/ultrasonic-range"
        },
        "r1aPag2cf": {
          "id": "r1aPag2cf",
          "position": {
            "x": 4,
            "y": 0,
            "units": "slots"
          },
          "type": "xod/core/clock"
        },
        "rkq2ax25z": {
          "id": "rkq2ax25z",
          "position": {
            "x": 2,
            "y": 2,
            "units": "slots"
          },
          "type": "xod/core/watch"
        }
      },
      "links": {
        "HkG_aen9z": {
          "id": "HkG_aen9z",
          "input": {
            "nodeId": "S1vSYencM",
            "pinKey": "BJfDr0exLf"
          },
          "output": {
            "nodeId": "r1aPag2cf",
            "pinKey": "HJU8CE2lW"
          }
        },
        "HyA2TlhcG": {
          "id": "HyA2TlhcG",
          "input": {
            "nodeId": "rkq2ax25z",
            "pinKey": "HkXK-dGob"
          },
          "output": {
            "nodeId": "S1vSYencM",
            "pinKey": "SJePHRge8G"
          }
        }
      },
      "path": "@/example"
    },
    "@/ultrasonic-range": {
      "nodes": {
        "BJfDr0exLf": {
          "boundLiterals": {
            "__out__": "Continuously"
          },
          "description": "Triggers new ultrasonic ping which would result in the output update once sound echo will be captured. Pulses coming within 60 ms window after last one are ignored to fight sensor’s PCB resonance.",
          "label": "PING",
          "id": "BJfDr0exLf",
          "position": {
            "x": 7.8,
            "y": -0.05,
            "units": "slots"
          },
          "type": "xod/patch-nodes/input-pulse"
        },
        "ByXwBCle8M": {
          "id": "ByXwBCle8M",
          "position": {
            "x": 0,
            "y": 1,
            "units": "slots"
          },
          "type": "xod/patch-nodes/not-implemented-in-xod"
        },
        "HyZDrAxeIG": {
          "description": "Board port to which sensor’s `echo` pin is connected.",
          "label": "ECHO",
          "id": "HyZDrAxeIG",
          "position": {
            "x": 4,
            "y": -0.05,
            "units": "slots"
          },
          "type": "xod/patch-nodes/input-number"
        },
        "SJePHRge8G": {
          "description": "Last measured distance in meters.",
          "label": "Dm",
          "id": "SJePHRge8G",
          "position": {
            "x": 0.25,
            "y": 2,
            "units": "slots"
          },
          "type": "xod/patch-nodes/output-number"
        },
        "SkDHCxlLG": {
          "description": "Board port to which sensor’s `trig` pin is connected.",
          "label": "TRIG",
          "id": "SkDHCxlLG",
          "position": {
            "x": 0.25,
            "y": -0.05,
            "units": "slots"
          },
          "type": "xod/patch-nodes/input-number"
        }
      },
      "path": "@/ultrasonic-range",
      "attachments": [
        {
          "filename": "patch.cpp",
          "encoding": "utf-8",
          "content": "\nstruct State {\n    TimeMs cooldownUntil = 0;\n};\n\n{{ GENERATED_CODE }}\n\nstatic const uint32_t HCSR04_COOLDOWN_MS = 60;\nstatic const uint32_t HCSR04_MAX_START_US = 5000;\nstatic const uint32_t HCSR04_MAX_ROUNDTRIP_US =\n    1000ul * 1000ul         // seconds to μs\n    * 4ul                   // max meters\n    * 2ul                   // to the moon and back\n    / 340ul;                // sound speed\n\nenum Status {\n    HCSR04_OK,\n    HCSR04_NO_ECHO,\n    HCSR04_WRONG_CONNECTION\n};\n\nStatus pingSync(uint8_t echoPort, uint8_t trigPort, uint32_t* outRoundtripUs) {\n    uint32_t maxUs;\n\n    // Request measurement: make a pulse for 10 μs.\n    pinMode(trigPort, OUTPUT);\n    digitalWrite(trigPort, HIGH);\n    delayMicroseconds(10);\n    digitalWrite(trigPort, LOW);\n\n    // Wait for echo pin rise which means ultrasonic burst success\n    maxUs = micros() + HCSR04_MAX_ROUNDTRIP_US;\n    pinMode(echoPort, INPUT);\n    while (digitalRead(echoPort) == LOW) {\n        if (micros() > maxUs) {\n            *outRoundtripUs = HCSR04_MAX_ROUNDTRIP_US;\n            return HCSR04_OK;\n            //return HCSR04_WRONG_CONNECTION;\n        }\n    }\n\n    // Now wait for echo line to be pulled back low which means echo capture\n    uint32_t tStart = micros();\n    maxUs = tStart + HCSR04_MAX_ROUNDTRIP_US;\n    while (digitalRead(echoPort) == HIGH) {\n        if (micros() > maxUs) {\n            *outRoundtripUs = -HCSR04_MAX_ROUNDTRIP_US;\n            return HCSR04_OK;\n            //return HCSR04_NO_ECHO;\n        }\n    }\n\n    *outRoundtripUs = micros() - tStart;\n    return HCSR04_OK;\n}\n\nvoid evaluate(Context ctx) {\n    if (!isInputDirty<input_PING>(ctx))\n        return;\n\n    auto state = getState(ctx);\n    if (millis() < state->cooldownUntil) {\n        emitValue<output_Dm>(ctx, -1);\n        return;\n    }\n\n    auto echoPort = (uint8_t)getValue<input_ECHO>(ctx);\n    auto trigPort = (uint8_t)getValue<input_TRIG>(ctx);\n\n    uint32_t t;\n    auto status = pingSync(\n        (uint8_t)getValue<input_ECHO>(ctx),\n        (uint8_t)getValue<input_TRIG>(ctx),\n        &t\n    );\n\n    // We should not ping too often as the PCB of the sensor could resonate\n    state->cooldownUntil = millis() + HCSR04_COOLDOWN_MS;\n\n    if (status == HCSR04_OK)\n        emitValue<output_Dm>(ctx, Number(t) / 1000000.0 * 170);\n}\n"
        }
      ]
    }
  },
  "version": "0.0.3",
  "description": "Copy of std Ultrasonic range, but returns Max distance on failure so we can assume nothing close to us. My sensor seems to go low on ping capture, not success, so I changed timeout to max round trip to get full range.",
  "name": "hc-sr04-ultrasonic"
}
