{
  "patches": {
    "@/example-advanced": {
      "@@type": "xod-project/Patch",
      "nodes": {
        "HkIVgRwUH": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "HkIVgRwUH",
          "position": {
            "x": 5,
            "y": 0
          },
          "type": "xod/units/standard-sound-speed",
          "@@type": "xod-project/Node"
        },
        "S1ahTpw8B": {
          "boundLiterals": {
            "SJeMLBsIUH": "D10",
            "rkMISoUUr": "D9"
          },
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "S1ahTpw8B",
          "position": {
            "x": 0,
            "y": 0
          },
          "type": "@/hc-sr04-device",
          "@@type": "xod-project/Node"
        },
        "SJIR1CD8B": {
          "boundLiterals": {
            "SJ4zUC_BD1-": "170"
          },
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "SJIR1CD8B",
          "position": {
            "x": 1,
            "y": 2
          },
          "type": "xod/core/multiply",
          "@@type": "xod-project/Node"
        },
        "SkYEeRwIr": {
          "boundLiterals": {
            "BytUCdHD1-": "2"
          },
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "SkYEeRwIr",
          "position": {
            "x": 5,
            "y": 1
          },
          "type": "xod/core/divide",
          "@@type": "xod-project/Node"
        },
        "SyfaTpvIH": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "SyfaTpvIH",
          "position": {
            "x": 1,
            "y": 1
          },
          "type": "@/ping",
          "@@type": "xod-project/Node"
        },
        "Syqd01_US": {
          "boundLiterals": {
            "B13SCNhl-": "0.2"
          },
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "Syqd01_US",
          "position": {
            "x": 2,
            "y": 0
          },
          "type": "xod/core/clock",
          "@@type": "xod-project/Node"
        },
        "SysoapvIS": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "height": 1,
            "width": 2
          },
          "id": "SysoapvIS",
          "position": {
            "x": 1,
            "y": 3
          },
          "type": "xod/debug/watch",
          "@@type": "xod-project/Node"
        }
      },
      "links": {
        "BJkSeCP8B": {
          "id": "BJkSeCP8B",
          "input": {
            "nodeId": "SJIR1CD8B",
            "pinKey": "SJ4zUC_BD1-"
          },
          "output": {
            "nodeId": "SkYEeRwIr",
            "pinKey": "BkqLCOSw1W"
          },
          "@@type": "xod-project/Link"
        },
        "BktRyAv8H": {
          "id": "BktRyAv8H",
          "input": {
            "nodeId": "SysoapvIS",
            "pinKey": "HkXK-dGob"
          },
          "output": {
            "nodeId": "SJIR1CD8B",
            "pinKey": "BkQzLCurwJZ"
          },
          "@@type": "xod-project/Link"
        },
        "ByutA1_LB": {
          "id": "ByutA1_LB",
          "input": {
            "nodeId": "SyfaTpvIH",
            "pinKey": "H1moQzcLIr"
          },
          "output": {
            "nodeId": "Syqd01_US",
            "pinKey": "HJU8CE2lW"
          },
          "@@type": "xod-project/Link"
        },
        "SkPAkCwIH": {
          "id": "SkPAkCwIH",
          "input": {
            "nodeId": "SJIR1CD8B",
            "pinKey": "B1GfLR_SPk-"
          },
          "output": {
            "nodeId": "SyfaTpvIH",
            "pinKey": "HJZo7GqIIr"
          },
          "@@type": "xod-project/Link"
        },
        "Sy7ap6wIr": {
          "id": "Sy7ap6wIr",
          "input": {
            "nodeId": "SyfaTpvIH",
            "pinKey": "Sy3uWavLr"
          },
          "output": {
            "nodeId": "S1ahTpw8B",
            "pinKey": "SJTISoL8B"
          },
          "@@type": "xod-project/Link"
        },
        "rJsElAvUH": {
          "id": "rJsElAvUH",
          "input": {
            "nodeId": "SkYEeRwIr",
            "pinKey": "SkdIRuBD1b"
          },
          "output": {
            "nodeId": "HkIVgRwUH",
            "pinKey": "B1gfJiULH"
          },
          "@@type": "xod-project/Link"
        }
      },
      "comments": {},
      "path": "@/example-advanced",
      "description": "",
      "attachments": []
    },
    "@/example-quick-start": {
      "@@type": "xod-project/Patch",
      "nodes": {
        "H1n8ZRvLH": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "height": 1,
            "width": 2
          },
          "id": "H1n8ZRvLH",
          "position": {
            "x": 2,
            "y": 2
          },
          "type": "xod/debug/watch",
          "@@type": "xod-project/Node"
        },
        "ryPLZAwIS": {
          "boundLiterals": {
            "BkHy258IB": "D9",
            "H1gBkhc88H": "D10"
          },
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "ryPLZAwIS",
          "position": {
            "x": 2,
            "y": 1
          },
          "type": "@/hc-sr04-range-meter",
          "@@type": "xod-project/Node"
        }
      },
      "links": {
        "Sk0IZAP8B": {
          "id": "Sk0IZAP8B",
          "input": {
            "nodeId": "H1n8ZRvLH",
            "pinKey": "HkXK-dGob"
          },
          "output": {
            "nodeId": "ryPLZAwIS",
            "pinKey": "HJrin98LS"
          },
          "@@type": "xod-project/Link"
        }
      },
      "comments": {},
      "path": "@/example-quick-start",
      "description": "",
      "attachments": []
    },
    "@/hc-sr04-device": {
      "@@type": "xod-project/Patch",
      "nodes": {
        "SJTISoL8B": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "SJTISoL8B",
          "position": {
            "x": 0,
            "y": 2
          },
          "type": "xod/patch-nodes/output-self",
          "@@type": "xod-project/Node"
        },
        "SJeMLBsIUH": {
          "boundLiterals": {},
          "description": "Board port to which sensor’s `trig` pin is connected.",
          "label": "TRIG",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "SJeMLBsIUH",
          "position": {
            "x": 0,
            "y": 0
          },
          "type": "xod/patch-nodes/input-port",
          "@@type": "xod-project/Node"
        },
        "r1Lwro8UH": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "r1Lwro8UH",
          "position": {
            "x": 0,
            "y": 1
          },
          "type": "xod/patch-nodes/not-implemented-in-xod",
          "@@type": "xod-project/Node"
        },
        "rkMISoUUr": {
          "boundLiterals": {},
          "description": "Board port to which sensor’s `echo` pin is connected.",
          "label": "ECHO",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "rkMISoUUr",
          "position": {
            "x": 2,
            "y": 0
          },
          "type": "xod/patch-nodes/input-port",
          "@@type": "xod-project/Node"
        }
      },
      "links": {},
      "comments": {},
      "path": "@/hc-sr04-device",
      "description": "",
      "attachments": [
        {
          "filename": "patch.cpp",
          "encoding": "utf8",
          "content": "node {\n    meta {\n        struct Device {\n            static constexpr typeof_ECHO echoPort = constant_input_ECHO;\n            static constexpr typeof_TRIG trigPort = constant_input_TRIG;\n        };\n        Device dev;\n        using Type = Device*;\n    }\n    void evaluate(Context ctx) {\n        pinMode(dev.trigPort, OUTPUT);\n        pinMode(dev.echoPort, INPUT);\n        emitValue<output_OUT>(ctx, &dev);\n    }\n}\n"
        }
      ]
    },
    "@/hc-sr04-range-meter": {
      "@@type": "xod-project/Patch",
      "nodes": {
        "BkHy258IB": {
          "boundLiterals": {},
          "description": "Board port to which sensor’s `echo` pin is connected.",
          "label": "ECHO",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "BkHy258IB",
          "position": {
            "x": 1,
            "y": 0
          },
          "type": "xod/patch-nodes/input-port",
          "@@type": "xod-project/Node"
        },
        "BkeSs3988B": {
          "boundLiterals": {},
          "description": "Fires when ping is done",
          "label": "OK",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "BkeSs3988B",
          "position": {
            "x": 1,
            "y": 4
          },
          "type": "xod/patch-nodes/output-pulse",
          "@@type": "xod-project/Node"
        },
        "Bksb-RPUH": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "Bksb-RPUH",
          "position": {
            "x": -2,
            "y": 1
          },
          "type": "xod/units/standard-sound-speed",
          "@@type": "xod-project/Node"
        },
        "By7JWCPUS": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "By7JWCPUS",
          "position": {
            "x": 0,
            "y": 1
          },
          "type": "@/hc-sr04-device",
          "@@type": "xod-project/Node"
        },
        "H1gBkhc88H": {
          "boundLiterals": {},
          "description": "Board port to which sensor’s `trig` pin is connected.",
          "label": "TRIG",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "H1gBkhc88H",
          "position": {
            "x": 0,
            "y": 0
          },
          "type": "xod/patch-nodes/input-port",
          "@@type": "xod-project/Node"
        },
        "HJboW-CPUB": {
          "boundLiterals": {
            "SJ4zUC_BD1-": "170"
          },
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "HJboW-CPUB",
          "position": {
            "x": -1,
            "y": 3
          },
          "type": "xod/core/multiply",
          "@@type": "xod-project/Node"
        },
        "HJrin98LS": {
          "boundLiterals": {},
          "description": "Last measured distance in meters. Will be set to +Inf if the sensor gets no echo back",
          "label": "Dm",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "HJrin98LS",
          "position": {
            "x": -1,
            "y": 4
          },
          "type": "xod/patch-nodes/output-number",
          "@@type": "xod-project/Node"
        },
        "HkMaeCw8r": {
          "boundLiterals": {
            "ByYWULHUr": "0.06"
          },
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "HkMaeCw8r",
          "position": {
            "x": 2,
            "y": 1
          },
          "type": "xod/core/throttle",
          "@@type": "xod-project/Node"
        },
        "SkxiZZAvLH": {
          "boundLiterals": {
            "BytUCdHD1-": "2"
          },
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "SkxiZZAvLH",
          "position": {
            "x": -2,
            "y": 2
          },
          "type": "xod/core/divide",
          "@@type": "xod-project/Node"
        },
        "rJ7Mnq8UB": {
          "boundLiterals": {
            "__out__": "Continuously"
          },
          "description": "Triggers new ultrasonic ping which will result in the output update once sound echo is captured. Pulses coming within 60 ms window after the last one are ignored to fight sensor’s PCB resonance.",
          "label": "UPD",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "rJ7Mnq8UB",
          "position": {
            "x": 2,
            "y": 0
          },
          "type": "xod/patch-nodes/input-pulse",
          "@@type": "xod-project/Node"
        },
        "rkuJ-0P8B": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "rkuJ-0P8B",
          "position": {
            "x": 0,
            "y": 2
          },
          "type": "@/ping",
          "@@type": "xod-project/Node"
        }
      },
      "links": {
        "ByTGWCvIr": {
          "id": "ByTGWCvIr",
          "input": {
            "nodeId": "BkeSs3988B",
            "pinKey": "__in__"
          },
          "output": {
            "nodeId": "rkuJ-0P8B",
            "pinKey": "Bkimz58LS"
          },
          "@@type": "xod-project/Link"
        },
        "HJSJZ0PLB": {
          "id": "HJSJZ0PLB",
          "input": {
            "nodeId": "By7JWCPUS",
            "pinKey": "SJeMLBsIUH"
          },
          "output": {
            "nodeId": "H1gBkhc88H",
            "pinKey": "__out__"
          },
          "@@type": "xod-project/Link"
        },
        "HkY7-0vLS": {
          "id": "HkY7-0vLS",
          "input": {
            "nodeId": "HJboW-CPUB",
            "pinKey": "B1GfLR_SPk-"
          },
          "output": {
            "nodeId": "SkxiZZAvLH",
            "pinKey": "BkqLCOSw1W"
          },
          "@@type": "xod-project/Link"
        },
        "HySpgCw8B": {
          "id": "HySpgCw8B",
          "input": {
            "nodeId": "HkMaeCw8r",
            "pinKey": "rkzZUUHLB"
          },
          "output": {
            "nodeId": "rJ7Mnq8UB",
            "pinKey": "__out__"
          },
          "@@type": "xod-project/Link"
        },
        "S1foZZCwUr": {
          "id": "S1foZZCwUr",
          "input": {
            "nodeId": "SkxiZZAvLH",
            "pinKey": "SkdIRuBD1b"
          },
          "output": {
            "nodeId": "Bksb-RPUH",
            "pinKey": "B1gfJiULH"
          },
          "@@type": "xod-project/Link"
        },
        "SyokbCD8r": {
          "id": "SyokbCD8r",
          "input": {
            "nodeId": "rkuJ-0P8B",
            "pinKey": "H1moQzcLIr"
          },
          "output": {
            "nodeId": "HkMaeCw8r",
            "pinKey": "H1H-LLHUr"
          },
          "@@type": "xod-project/Link"
        },
        "rJ7m-0vIH": {
          "id": "rJ7m-0vIH",
          "input": {
            "nodeId": "HJboW-CPUB",
            "pinKey": "SJ4zUC_BD1-"
          },
          "output": {
            "nodeId": "rkuJ-0P8B",
            "pinKey": "HJZo7GqIIr"
          },
          "@@type": "xod-project/Link"
        },
        "rJV1W0vIS": {
          "id": "rJV1W0vIS",
          "input": {
            "nodeId": "By7JWCPUS",
            "pinKey": "rkMISoUUr"
          },
          "output": {
            "nodeId": "BkHy258IB",
            "pinKey": "__out__"
          },
          "@@type": "xod-project/Link"
        },
        "rJoMbCDIS": {
          "id": "rJoMbCDIS",
          "input": {
            "nodeId": "HJrin98LS",
            "pinKey": "__in__"
          },
          "output": {
            "nodeId": "HJboW-CPUB",
            "pinKey": "BkQzLCurwJZ"
          },
          "@@type": "xod-project/Link"
        },
        "rkc1-0vUB": {
          "id": "rkc1-0vUB",
          "input": {
            "nodeId": "rkuJ-0P8B",
            "pinKey": "Sy3uWavLr"
          },
          "output": {
            "nodeId": "By7JWCPUS",
            "pinKey": "SJTISoL8B"
          },
          "@@type": "xod-project/Link"
        }
      },
      "comments": {},
      "path": "@/hc-sr04-range-meter",
      "description": "",
      "attachments": []
    },
    "@/ping": {
      "@@type": "xod-project/Patch",
      "nodes": {
        "Bkimz58LS": {
          "boundLiterals": {},
          "description": "Fires when ping is done",
          "label": "DONE",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "Bkimz58LS",
          "position": {
            "x": 2,
            "y": 2
          },
          "type": "xod/patch-nodes/output-pulse",
          "@@type": "xod-project/Node"
        },
        "H1moQzcLIr": {
          "boundLiterals": {
            "__out__": "Continuously"
          },
          "description": "Triggers new ultrasonic ping which would result in the output update once sound echo will be captured. Pulses coming within 60 ms window after last one are ignored to fight sensor’s PCB resonance.",
          "label": "PING",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "H1moQzcLIr",
          "position": {
            "x": 2,
            "y": 0
          },
          "type": "xod/patch-nodes/input-pulse",
          "@@type": "xod-project/Node"
        },
        "HJZo7GqIIr": {
          "boundLiterals": {},
          "description": "Last measured sound roundtrip time in seconds.",
          "label": "Ts",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "HJZo7GqIIr",
          "position": {
            "x": 0,
            "y": 2
          },
          "type": "xod/patch-nodes/output-number",
          "@@type": "xod-project/Node"
        },
        "Hy4omfq8Ur": {
          "boundLiterals": {},
          "description": "",
          "label": "",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "Hy4omfq8Ur",
          "position": {
            "x": 0,
            "y": 1
          },
          "type": "xod/patch-nodes/not-implemented-in-xod",
          "@@type": "xod-project/Node"
        },
        "Sy3uWavLr": {
          "boundLiterals": {},
          "description": "",
          "label": "DEV",
          "arityLevel": 1,
          "size": {
            "width": 0,
            "height": 0
          },
          "id": "Sy3uWavLr",
          "position": {
            "x": 0,
            "y": 0
          },
          "type": "@/input-hc-sr04-device",
          "@@type": "xod-project/Node"
        }
      },
      "links": {},
      "comments": {},
      "path": "@/ping",
      "description": "Measures sound roundtrip time with HC-SR04 ultrasonic range meter. Outputs infinity on no echo. Possible errors: — Invalid port — Wrong connection\n",
      "attachments": [
        {
          "filename": "patch.cpp",
          "encoding": "utf8",
          "content": "#pragma XOD evaluate_on_pin disable\n#pragma XOD evaluate_on_pin enable input_PING\n#pragma XOD error_raise enable\n\nnode {\n    static const uint32_t HCSR04_MAX_START_US = 5000;\n    static const uint32_t HCSR04_MAX_ROUNDTRIP_US =\n        1000ul * 1000ul         // seconds to μs\n        * 4ul                   // max meters\n        * 2ul                   // to the moon and back\n        / 340ul;                // sound speed\n\n    enum Status {\n        HCSR04_OK,\n        HCSR04_NO_ECHO,\n        HCSR04_WRONG_CONNECTION\n    };\n\n    Status pingSync(uint8_t echoPort, uint8_t trigPort, uint32_t* outRoundtripUs) {\n        uint32_t maxUs;\n\n        // Request measurement: make a pulse for 10 μs.\n        pinMode(trigPort, OUTPUT);\n        digitalWrite(trigPort, HIGH);\n        delayMicroseconds(10);\n        digitalWrite(trigPort, LOW);\n\n        // Wait for echo pin rise which means ultrasonic burst success\n        maxUs = micros() + HCSR04_MAX_START_US;\n        pinMode(echoPort, INPUT);\n        while (digitalRead(echoPort) == LOW) {\n            if (micros() > maxUs)\n                return HCSR04_WRONG_CONNECTION;\n        }\n\n        // Now wait for echo line to be pulled back low which means echo capture\n        uint32_t tStart = micros();\n        maxUs = tStart + HCSR04_MAX_ROUNDTRIP_US;\n        while (digitalRead(echoPort) == HIGH) {\n            if (micros() > maxUs)\n                return HCSR04_NO_ECHO;\n        }\n\n        *outRoundtripUs = micros() - tStart;\n        return HCSR04_OK;\n    }\n\n    void evaluate(Context ctx) {\n        if (!isInputDirty<input_PING>(ctx))\n            return;\n\n        auto dev = getValue<input_DEV>(ctx);\n\n        // TODO: static port validation\n        if (!isValidDigitalPort(dev->echoPort) || !isValidDigitalPort(dev->trigPort)) {\n            raiseError(ctx); // Invalid port\n            return;\n        }\n\n        uint32_t t;\n        auto status = pingSync(\n            dev->echoPort,\n            dev->trigPort,\n            &t\n        );\n\n        if (status == HCSR04_OK) {\n            emitValue<output_Ts>(ctx, Number(t) / 1000000.0);\n            emitValue<output_DONE>(ctx, 1);\n        } else if (status == HCSR04_NO_ECHO) {\n            emitValue<output_Ts>(ctx, INFINITY);\n            emitValue<output_DONE>(ctx, 1);\n        } else {\n            raiseError(ctx); // HCSR04_WRONG_CONNECTION\n        }\n    }\n}\n"
        }
      ]
    }
  },
  "authors": [],
  "license": "AGPL-3.0",
  "version": "0.37.3",
  "description": "Nodes to work with the HC-SR04 ultrasonic range meters.",
  "apiKey": "",
  "name": "hc-sr04"
}
